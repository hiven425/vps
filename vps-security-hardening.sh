#!/bin/bash

# VPSå®‰å…¨åŠ å›ºä¸“ç”¨å·¥å…·
# ç‰ˆæœ¬ï¼š3.0.0
# ä¸“æ³¨ï¼šç³»ç»Ÿå®‰å…¨åŠ å›ºã€SSHé…ç½®ã€é˜²ç«å¢™ç®¡ç†ã€å…¥ä¾µé˜²æŠ¤
# æ”¯æŒç³»ç»Ÿï¼šUbuntu/Debian/CentOS

set -euo pipefail

#region //å…¨å±€é…ç½®
version="3.0.0"
script_name="vps-security-hardening"

# é¢œè‰²å®šä¹‰
if [[ -t 1 ]] && command -v tput >/dev/null 2>&1 && tput colors >/dev/null 2>&1; then
    red='\033[31m'
    green='\033[32m'
    yellow='\033[33m'
    blue='\033[34m'
    pink='\033[35m'
    cyan='\033[36m'
    white='\033[0m'
    bold='\033[1m'
else
    red='' green='' yellow='' blue='' pink='' cyan='' white='' bold=''
fi

# é…ç½®ç›®å½•å’Œæ–‡ä»¶
config_dir="/etc/vps-security"
backup_dir="$config_dir/backup"
log_file="/var/log/vps-security-hardening.log"
ssh_config_file="/etc/ssh/sshd_config.d/99-vps-security.conf"

# ç³»ç»Ÿä¿¡æ¯
OS=""
OS_VERSION=""
PACKAGE_MANAGER=""
#endregion

#region //åŸºç¡€å·¥å…·å‡½æ•°
log_operation() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] $message" >> "$log_file"
}

error_exit() {
    local message="$1"
    echo -e "${red}âœ— é”™è¯¯: ${message}${white}" >&2
    log_operation "ERROR: $message"
    exit 1
}

success_msg() {
    local message="$1"
    echo -e "${green}âœ“ ${message}${white}"
    log_operation "SUCCESS: $message"
}

warn_msg() {
    local message="$1"
    echo -e "${yellow}âš  ${message}${white}"
    log_operation "WARNING: $message"
}

info_msg() {
    local message="$1"
    echo -e "${blue}â„¹ ${message}${white}"
    log_operation "INFO: $message"
}

check_root_permission() {
    if [[ $EUID -ne 0 ]]; then
        error_exit "æ­¤è„šæœ¬éœ€è¦rootæƒé™è¿è¡Œã€‚è¯·ä½¿ç”¨: sudo $0"
    fi
}

create_directories() {
    local dirs=("$config_dir" "$backup_dir" "$(dirname "$log_file")")
    for dir in "${dirs[@]}"; do
        if [[ ! -d "$dir" ]]; then
            mkdir -p "$dir"
            chmod 750 "$dir"
        fi
    done
}

detect_system() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        OS=$ID
        OS_VERSION=$VERSION_ID
    else
        error_exit "æ— æ³•æ£€æµ‹ç³»ç»Ÿç‰ˆæœ¬"
    fi
    
    case $OS in
        ubuntu|debian)
            PACKAGE_MANAGER="apt"
            ;;
        centos|rhel|fedora)
            PACKAGE_MANAGER="yum"
            if command -v dnf >/dev/null 2>&1; then
                PACKAGE_MANAGER="dnf"
            fi
            ;;
        *)
            error_exit "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OS"
            ;;
    esac
    
    info_msg "æ£€æµ‹åˆ°ç³»ç»Ÿ: $OS $OS_VERSION"
}

backup_file() {
    local file="$1"
    local backup_suffix="$(date +%Y%m%d_%H%M%S)"
    
    if [[ -f "$file" ]]; then
        local backup_path="$backup_dir/$(basename "$file").backup.$backup_suffix"
        cp "$file" "$backup_path"
        success_msg "æ–‡ä»¶å·²å¤‡ä»½: $file -> $backup_path"
    fi
}
#endregion

#region //SSHå®‰å…¨é…ç½®æ¨¡å—
get_ssh_config_value() {
    local key="$1"
    local default_value="${2:-}"
    
    if command -v sshd >/dev/null 2>&1; then
        sshd -T 2>/dev/null | grep -i "^$key " | awk '{print $2}' | head -1 || echo "$default_value"
    else
        echo "$default_value"
    fi
}

validate_ssh_port() {
    local port="$1"
    
    if ! [[ "$port" =~ ^[0-9]+$ ]]; then
        return 1
    fi
    
    if [[ $port -lt 1024 || $port -gt 65535 ]]; then
        return 1
    fi
    
    if ss -tuln 2>/dev/null | grep -q ":$port "; then
        warn_msg "ç«¯å£ $port å¯èƒ½å·²è¢«å ç”¨"
        return 1
    fi
    
    return 0
}

generate_ssh_keys() {
    local key_type="${1:-ed25519}"
    local key_dir="$HOME/.ssh"
    
    info_msg "ç”ŸæˆSSHå¯†é’¥å¯¹..."
    
    mkdir -p "$key_dir"
    chmod 700 "$key_dir"
    
    local private_key="$key_dir/id_$key_type"
    local public_key="$private_key.pub"
    
    if [[ -f "$private_key" ]]; then
        warn_msg "SSHå¯†é’¥å·²å­˜åœ¨: $private_key"
        return 0
    fi
    
    case "$key_type" in
        "ed25519")
            ssh-keygen -t ed25519 -f "$private_key" -N "" -C "Generated by VPS Security Tool $(date +%Y%m%d)"
            ;;
        "rsa")
            ssh-keygen -t rsa -b 4096 -f "$private_key" -N "" -C "Generated by VPS Security Tool $(date +%Y%m%d)"
            ;;
        *)
            error_exit "ä¸æ”¯æŒçš„å¯†é’¥ç±»å‹: $key_type"
            ;;
    esac
    
    chmod 600 "$private_key"
    chmod 644 "$public_key"
    
    success_msg "SSHå¯†é’¥ç”Ÿæˆå®Œæˆ"
    echo
    echo -e "${cyan}å…¬é’¥å†…å®¹ (è¯·æ·»åŠ åˆ°ç›®æ ‡æœåŠ¡å™¨çš„ ~/.ssh/authorized_keys):${white}"
    echo -e "${green}$(cat "$public_key")${white}"
    echo
}

handle_cloud_config_conflicts() {
    info_msg "æ£€æŸ¥äº‘æœåŠ¡å•†SSHé…ç½®å†²çª..."
    
    local ssh_config_dir="/etc/ssh/sshd_config.d"
    local cloud_configs=(
        "50-cloud-init.conf"
        "60-cloudimg-settings.conf"
        "99-cloudimg-settings.conf"
        "azure.conf"
        "google.conf"
    )
    
    local conflicts_found=false
    
    for config in "${cloud_configs[@]}"; do
        local config_path="$ssh_config_dir/$config"
        if [[ -f "$config_path" ]]; then
            conflicts_found=true
            backup_file "$config_path"
            
            local disabled_name="${config}.disabled-$(date +%s)"
            mv "$config_path" "$ssh_config_dir/$disabled_name"
            success_msg "å·²ç¦ç”¨äº‘é…ç½®: $config -> $disabled_name"
        fi
    done
    
    if [[ "$conflicts_found" == "false" ]]; then
        success_msg "æœªå‘ç°äº‘æœåŠ¡å•†é…ç½®å†²çª"
    fi
}

generate_secure_ssh_config() {
    local ssh_port="$1"
    local permit_root="${2:-prohibit-password}"
    local password_auth="${3:-no}"
    
    info_msg "ç”Ÿæˆå®‰å…¨SSHé…ç½®..."
    
    # å¤‡ä»½åŸé…ç½®
    backup_file "/etc/ssh/sshd_config"
    
    # åˆ›å»ºé…ç½®ç›®å½•
    mkdir -p "$(dirname "$ssh_config_file")"
    
    cat > "$ssh_config_file" << EOF
# VPSå®‰å…¨åŠ å›ºå·¥å…· - SSHå®‰å…¨é…ç½®
# ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
# ç‰ˆæœ¬: $version
# 
# æ­¤é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§é«˜äºä¸»é…ç½®æ–‡ä»¶å’Œäº‘æœåŠ¡å•†é…ç½®

# === åŸºç¡€è¿æ¥è®¾ç½® ===
Port $ssh_port
Protocol 2
AddressFamily any

# === è®¤è¯è®¾ç½® ===
# Rootç™»å½•æ§åˆ¶
PermitRootLogin $permit_root

# è®¤è¯æ–¹å¼
PasswordAuthentication $password_auth
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys

# å®‰å…¨è®¤è¯è®¾ç½®
PermitEmptyPasswords no
ChallengeResponseAuthentication no
KbdInteractiveAuthentication no
HostbasedAuthentication no
IgnoreRhosts yes
UsePAM yes

# === è¿æ¥å®‰å…¨é™åˆ¶ ===
# è®¤è¯å°è¯•é™åˆ¶
MaxAuthTries 3
MaxSessions 4
MaxStartups 10:30:60

# ç™»å½•æ—¶é—´é™åˆ¶
LoginGraceTime 60

# è¿æ¥ä¿æ´»è®¾ç½®
ClientAliveInterval 300
ClientAliveCountMax 2
TCPKeepAlive yes

# === åŠŸèƒ½æ§åˆ¶ ===
# X11è½¬å‘ (é€šå¸¸åº”è¯¥ç¦ç”¨)
X11Forwarding no
X11DisplayOffset 10
X11UseLocalhost yes

# ç«¯å£è½¬å‘æ§åˆ¶
AllowTcpForwarding yes
AllowStreamLocalForwarding no
GatewayPorts no
PermitTunnel no

# === æ€§èƒ½ä¼˜åŒ– ===
# DNSè§£æ (ç¦ç”¨ä»¥æé«˜è¿æ¥é€Ÿåº¦)
UseDNS no

# GSSAPIè®¤è¯ (é€šå¸¸ä¸éœ€è¦)
GSSAPIAuthentication no
GSSAPICleanupCredentials yes

# å‹ç¼©è®¾ç½®
Compression delayed

# === ç°ä»£åŠ å¯†ç®—æ³•è®¾ç½® ===
# å¯†é’¥äº¤æ¢ç®—æ³• (ä»…å…è®¸å®‰å…¨ç®—æ³•)
KexAlgorithms curve25519-sha256@libssh.org,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group16-sha512

# åŠ å¯†ç®—æ³• (ä»…å…è®¸ç°ä»£å®‰å…¨ç®—æ³•)
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

# MACç®—æ³• (æ¶ˆæ¯è®¤è¯ç )
MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,hmac-sha2-512

# ä¸»æœºå¯†é’¥ç®—æ³•
HostKeyAlgorithms ssh-ed25519,ecdsa-sha2-nistp521,ecdsa-sha2-nistp384,ecdsa-sha2-nistp256,rsa-sha2-512,rsa-sha2-256

# === æ—¥å¿—è®¾ç½® ===
SyslogFacility AUTH
LogLevel INFO

# === å…¶ä»–å®‰å…¨è®¾ç½® ===
# ä¸¥æ ¼æ¨¡å¼ (æ£€æŸ¥æ–‡ä»¶æƒé™)
StrictModes yes

# ç™»å½•ä¿¡æ¯
PrintMotd no
PrintLastLog yes

# ç¦ç”¨è¿‡æ—¶åŠŸèƒ½
KerberosAuthentication no
EOF
    
    chmod 644 "$ssh_config_file"
    success_msg "SSHé…ç½®æ–‡ä»¶å·²ç”Ÿæˆ: $ssh_config_file"
    
    # éªŒè¯é…ç½®è¯­æ³•
    if sshd -t 2>/dev/null; then
        success_msg "SSHé…ç½®è¯­æ³•éªŒè¯é€šè¿‡"
        return 0
    else
        error_exit "SSHé…ç½®è¯­æ³•éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
    fi
}

ssh_security_audit() {
    info_msg "æ‰§è¡ŒSSHå®‰å…¨å®¡è®¡..."
    
    local issues=0
    local warnings=0
    
    echo
    echo -e "${cyan}=== SSHå®‰å…¨å®¡è®¡æŠ¥å‘Š ===${white}"
    
    # æ£€æŸ¥ç«¯å£
    local current_port=$(get_ssh_config_value "port" "22")
    if [[ "$current_port" == "22" ]]; then
        echo -e "${red}âœ— ä½¿ç”¨é»˜è®¤SSHç«¯å£22ï¼Œæ˜“å—æ‰«ææ”»å‡»${white}"
        ((issues++))
    else
        echo -e "${green}âœ“ SSHç«¯å£å·²ä¿®æ”¹: $current_port${white}"
    fi
    
    # æ£€æŸ¥Rootç™»å½•
    local root_login=$(get_ssh_config_value "permitrootlogin" "yes")
    case "$root_login" in
        "yes")
            echo -e "${red}âœ— å…è®¸Rootå¯†ç ç™»å½•ï¼Œå®‰å…¨é£é™©æé«˜${white}"
            ((issues++))
            ;;
        "prohibit-password"|"without-password")
            echo -e "${green}âœ“ Rootä»…å…è®¸å¯†é’¥ç™»å½•${white}"
            ;;
        "no")
            echo -e "${green}âœ“ å®Œå…¨ç¦æ­¢Rootç™»å½•${white}"
            ;;
    esac
    
    # æ£€æŸ¥å¯†ç è®¤è¯
    local password_auth=$(get_ssh_config_value "passwordauthentication" "yes")
    if [[ "$password_auth" == "yes" ]]; then
        echo -e "${yellow}âš  å¯ç”¨äº†å¯†ç è®¤è¯ï¼Œå­˜åœ¨æš´åŠ›ç ´è§£é£é™©${white}"
        ((warnings++))
    else
        echo -e "${green}âœ“ å¯†ç è®¤è¯å·²ç¦ç”¨${white}"
    fi
    
    # æ£€æŸ¥å¯†é’¥è®¤è¯
    local pubkey_auth=$(get_ssh_config_value "pubkeyauthentication" "yes")
    if [[ "$pubkey_auth" == "yes" ]]; then
        echo -e "${green}âœ“ å…¬é’¥è®¤è¯å·²å¯ç”¨${white}"
    else
        echo -e "${yellow}âš  å…¬é’¥è®¤è¯æœªå¯ç”¨${white}"
        ((warnings++))
    fi
    
    # æ£€æŸ¥ç©ºå¯†ç 
    local empty_passwords=$(get_ssh_config_value "permitemptypasswords" "no")
    if [[ "$empty_passwords" == "yes" ]]; then
        echo -e "${red}âœ— å…è®¸ç©ºå¯†ç ç™»å½•ï¼Œå®‰å…¨é£é™©æé«˜${white}"
        ((issues++))
    else
        echo -e "${green}âœ“ ç¦æ­¢ç©ºå¯†ç ç™»å½•${white}"
    fi
    
    echo
    echo -e "${cyan}å®¡è®¡æ€»ç»“:${white}"
    if [[ $issues -eq 0 && $warnings -eq 0 ]]; then
        echo -e "${green}âœ“ SSHé…ç½®å®‰å…¨å®¡è®¡é€šè¿‡${white}"
    else
        echo -e "${yellow}å‘ç° $issues ä¸ªä¸¥é‡é—®é¢˜ï¼Œ$warnings ä¸ªè­¦å‘Š${white}"
    fi
    
    return $((issues + warnings))
}

restart_ssh_service() {
    local current_port=$(get_ssh_config_value "port" "22")
    info_msg "é‡å¯å‰SSHç«¯å£: $current_port"
    
    # ç¡®ä¿é…ç½®ä¼˜å…ˆçº§
    handle_cloud_config_conflicts
    
    # é‡å¯SSHæœåŠ¡
    if systemctl restart sshd 2>/dev/null || systemctl restart ssh 2>/dev/null; then
        sleep 2
        local new_port=$(get_ssh_config_value "port" "22")
        
        if [[ "$current_port" == "$new_port" ]]; then
            success_msg "SSHæœåŠ¡é‡å¯æˆåŠŸï¼Œç«¯å£ä¿æŒä¸º: $new_port"
        else
            warn_msg "SSHç«¯å£å‘ç”Ÿå˜åŒ–: $current_port -> $new_port"
        fi
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        if systemctl is-active sshd >/dev/null 2>&1 || systemctl is-active ssh >/dev/null 2>&1; then
            success_msg "SSHæœåŠ¡è¿è¡Œæ­£å¸¸"
        else
            error_exit "SSHæœåŠ¡é‡å¯åçŠ¶æ€å¼‚å¸¸"
        fi
    else
        error_exit "SSHæœåŠ¡é‡å¯å¤±è´¥"
    fi
}

configure_ssh_security() {
    clear
    echo -e "${cyan}=== SSHå®‰å…¨é…ç½® ===${white}"
    echo
    
    # æ˜¾ç¤ºå½“å‰é…ç½®
    local current_port=$(get_ssh_config_value "port" "22")
    local current_root=$(get_ssh_config_value "permitrootlogin" "yes")
    local current_password=$(get_ssh_config_value "passwordauthentication" "yes")
    
    echo "å½“å‰SSHé…ç½®:"
    echo "  ç«¯å£: $current_port"
    echo "  Rootç™»å½•: $current_root"
    echo "  å¯†ç è®¤è¯: $current_password"
    echo
    
    # è·å–æ–°ç«¯å£
    local new_port
    while true; do
        read -p "è¯·è¾“å…¥æ–°çš„SSHç«¯å£ (1024-65535) [é»˜è®¤: 55520]: " new_port
        new_port=${new_port:-55520}
        
        if validate_ssh_port "$new_port"; then
            break
        else
            warn_msg "ç«¯å£ $new_port æ— æ•ˆæˆ–å·²è¢«å ç”¨ï¼Œè¯·é‡æ–°è¾“å…¥"
        fi
    done
    
    # Rootç™»å½•è®¾ç½®
    echo
    echo "Rootç™»å½•é€‰é¡¹:"
    echo "1. no - å®Œå…¨ç¦æ­¢Rootç™»å½• (æœ€å®‰å…¨)"
    echo "2. prohibit-password - ä»…å…è®¸å¯†é’¥ç™»å½• (æ¨è)"
    echo "3. yes - å…è®¸å¯†ç ç™»å½• (ä¸æ¨è)"
    echo
    
    local root_choice
    read -p "è¯·é€‰æ‹©Rootç™»å½•æ–¹å¼ [1-3, é»˜è®¤: 2]: " root_choice
    
    local permit_root
    case "${root_choice:-2}" in
        1) permit_root="no" ;;
        2) permit_root="prohibit-password" ;;
        3) 
            warn_msg "å…è®¸Rootå¯†ç ç™»å½•å­˜åœ¨ä¸¥é‡å®‰å…¨é£é™©ï¼"
            read -p "ç¡®è®¤è¦å…è®¸Rootå¯†ç ç™»å½•å—ï¼Ÿ(y/N): " confirm
            if [[ "$confirm" =~ ^[Yy]$ ]]; then
                permit_root="yes"
            else
                permit_root="prohibit-password"
            fi
            ;;
        *) permit_root="prohibit-password" ;;
    esac
    
    # å¯†ç è®¤è¯è®¾ç½®
    echo
    echo "å¯†ç è®¤è¯é€‰é¡¹:"
    echo "1. no - ç¦ç”¨å¯†ç è®¤è¯ï¼Œä»…ä½¿ç”¨å¯†é’¥ (æ¨è)"
    echo "2. yes - å…è®¸å¯†ç è®¤è¯"
    echo
    
    local password_choice
    read -p "è¯·é€‰æ‹©å¯†ç è®¤è¯æ–¹å¼ [1-2, é»˜è®¤: 1]: " password_choice
    
    local password_auth
    case "${password_choice:-1}" in
        1) password_auth="no" ;;
        2)
            warn_msg "å…è®¸å¯†ç è®¤è¯å¯èƒ½å­˜åœ¨æš´åŠ›ç ´è§£é£é™©ï¼"
            read -p "ç¡®è®¤è¦å…è®¸å¯†ç è®¤è¯å—ï¼Ÿ(y/N): " confirm
            if [[ "$confirm" =~ ^[Yy]$ ]]; then
                password_auth="yes"
            else
                password_auth="no"
            fi
            ;;
        *) password_auth="no" ;;
    esac
    
    # ç”ŸæˆSSHå¯†é’¥ (å¦‚æœç¦ç”¨å¯†ç è®¤è¯)
    if [[ "$password_auth" == "no" ]]; then
        echo
        read -p "æ˜¯å¦ç”Ÿæˆæ–°çš„SSHå¯†é’¥ï¼Ÿ(Y/n): " key_confirm
        if [[ ! "$key_confirm" =~ ^[Nn]$ ]]; then
            echo
            echo "å¯†é’¥ç±»å‹é€‰é¡¹:"
            echo "1. ed25519 - ç°ä»£åŠ å¯†ç®—æ³• (æ¨è)"
            echo "2. rsa - ä¼ ç»ŸRSAç®—æ³•"
            echo
            
            local key_choice
            read -p "è¯·é€‰æ‹©å¯†é’¥ç±»å‹ [1-2, é»˜è®¤: 1]: " key_choice
            
            local key_type
            case "${key_choice:-1}" in
                1) key_type="ed25519" ;;
                2) key_type="rsa" ;;
                *) key_type="ed25519" ;;
            esac
            
            generate_ssh_keys "$key_type"
        fi
    fi
    
    # åº”ç”¨é…ç½®
    echo
    info_msg "åº”ç”¨SSHå®‰å…¨é…ç½®..."
    generate_secure_ssh_config "$new_port" "$permit_root" "$password_auth"
    
    # é…ç½®æ‘˜è¦
    echo
    echo -e "${cyan}é…ç½®æ‘˜è¦:${white}"
    echo "  SSHç«¯å£: $new_port"
    echo "  Rootç™»å½•: $permit_root"
    echo "  å¯†ç è®¤è¯: $password_auth"
    echo "  é…ç½®æ–‡ä»¶: $ssh_config_file"
    echo
    
    # é‡å¯æœåŠ¡ç¡®è®¤
    read -p "æ˜¯å¦ç°åœ¨é‡å¯SSHæœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆï¼Ÿ(y/N): " restart_confirm
    if [[ "$restart_confirm" =~ ^[Yy]$ ]]; then
        restart_ssh_service
        
        echo
        success_msg "SSHå®‰å…¨é…ç½®å®Œæˆï¼"
        echo
        echo -e "${yellow}é‡è¦æé†’:${white}"
        echo "1. SSHç«¯å£å·²æ›´æ”¹ä¸º: $new_port"
        echo "2. è¯·åœ¨æ–°ç»ˆç«¯æµ‹è¯•è¿æ¥: ssh -p $new_port user@server"
        echo "3. ç¡®è®¤è¿æ¥æ­£å¸¸åå†æ–­å¼€å½“å‰ä¼šè¯"
        if [[ "$password_auth" == "no" ]]; then
            echo "4. å¯†ç è®¤è¯å·²ç¦ç”¨ï¼Œè¯·ç¡®ä¿å·²é…ç½®SSHå¯†é’¥"
        fi
    else
        warn_msg "SSHæœåŠ¡æœªé‡å¯ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œé‡å¯å‘½ä»¤"
        echo "systemctl restart sshd  # æˆ– systemctl restart ssh"
    fi
}
#endregion

#region //é˜²ç«å¢™é…ç½®æ¨¡å—
install_ufw() {
    info_msg "å®‰è£…UFWé˜²ç«å¢™..."
    
    case $PACKAGE_MANAGER in
        apt)
            apt update -qq && apt install -y ufw
            ;;
        yum|dnf)
            $PACKAGE_MANAGER install -y ufw
            ;;
    esac
    
    success_msg "UFWé˜²ç«å¢™å®‰è£…å®Œæˆ"
}

configure_ufw_firewall() {
    info_msg "é…ç½®UFWé˜²ç«å¢™..."
    
    # æ£€æŸ¥å¹¶å®‰è£…UFW
    if ! command -v ufw >/dev/null 2>&1; then
        install_ufw
    fi
    
    # å¤‡ä»½ç°æœ‰è§„åˆ™
    if [[ -f /etc/ufw/user.rules ]]; then
        backup_file "/etc/ufw/user.rules"
    fi
    
    # é‡ç½®é˜²ç«å¢™è§„åˆ™
    ufw --force reset
    
    # è®¾ç½®é»˜è®¤ç­–ç•¥
    ufw default deny incoming
    ufw default allow outgoing
    
    # è·å–SSHç«¯å£
    local ssh_port=$(get_ssh_config_value "port" "22")
    
    # å…è®¸åŸºç¡€æœåŠ¡
    ufw allow "$ssh_port/tcp" comment "SSH"
    ufw allow 80/tcp comment "HTTP"
    ufw allow 443/tcp comment "HTTPS"
    
    # è¯¢é—®æ˜¯å¦å…è®¸å…¶ä»–ç«¯å£
    echo
    echo "æ˜¯å¦éœ€è¦å¼€æ”¾å…¶ä»–ç«¯å£ï¼Ÿ"
    echo "å¸¸ç”¨ç«¯å£ï¼š"
    echo "  21/tcp - FTP"
    echo "  25/tcp - SMTP"
    echo "  53/tcp,53/udp - DNS"
    echo "  110/tcp - POP3"
    echo "  143/tcp - IMAP"
    echo "  993/tcp - IMAPS"
    echo "  995/tcp - POP3S"
    echo
    
    read -p "æ˜¯å¦å¼€æ”¾FTPç«¯å£21ï¼Ÿ(y/N): " ftp_confirm
    if [[ "$ftp_confirm" =~ ^[Yy]$ ]]; then
        ufw allow 21/tcp comment "FTP"
    fi
    
    read -p "æ˜¯å¦å¼€æ”¾é‚®ä»¶æœåŠ¡ç«¯å£ï¼Ÿ(y/N): " mail_confirm
    if [[ "$mail_confirm" =~ ^[Yy]$ ]]; then
        ufw allow 25/tcp comment "SMTP"
        ufw allow 110/tcp comment "POP3"
        ufw allow 143/tcp comment "IMAP"
        ufw allow 993/tcp comment "IMAPS"
        ufw allow 995/tcp comment "POP3S"
    fi
    
    read -p "è¯·è¾“å…¥å…¶ä»–éœ€è¦å¼€æ”¾çš„ç«¯å£ (æ ¼å¼: 8080/tcp,9000/udp æˆ–ç›´æ¥å›è½¦è·³è¿‡): " custom_ports
    if [[ -n "$custom_ports" ]]; then
        IFS=',' read -ra ports <<< "$custom_ports"
        for port in "${ports[@]}"; do
            if [[ "$port" =~ ^[0-9]+/(tcp|udp)$ ]]; then
                ufw allow "$port" comment "Custom"
                success_msg "å·²å¼€æ”¾ç«¯å£: $port"
            else
                warn_msg "æ— æ•ˆç«¯å£æ ¼å¼: $port"
            fi
        done
    fi
    
    # å¯ç”¨é˜²ç«å¢™
    ufw --force enable
    
    success_msg "UFWé˜²ç«å¢™é…ç½®å®Œæˆ"
    
    # æ˜¾ç¤ºå½“å‰è§„åˆ™
    echo
    echo -e "${cyan}å½“å‰é˜²ç«å¢™è§„åˆ™:${white}"
    ufw status numbered
}

configure_fail2ban() {
    info_msg "é…ç½®fail2banå…¥ä¾µé˜²æŠ¤..."
    
    # æ£€æŸ¥å¹¶å®‰è£…fail2ban
    if ! command -v fail2ban-server >/dev/null 2>&1; then
        case $PACKAGE_MANAGER in
            apt)
                apt update -qq && apt install -y fail2ban
                ;;
            yum|dnf)
                $PACKAGE_MANAGER install -y fail2ban
                ;;
        esac
    fi
    
    # å¤‡ä»½åŸé…ç½®
    backup_file "/etc/fail2ban/jail.conf"
    
    # åˆ›å»ºæœ¬åœ°é…ç½®æ–‡ä»¶
    cat > /etc/fail2ban/jail.local << EOF
# VPSå®‰å…¨åŠ å›ºå·¥å…· - fail2bané…ç½®
# ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')

[DEFAULT]
# é»˜è®¤å¿½ç•¥IP (æœ¬åœ°åœ°å€)
ignoreip = 127.0.0.1/8 ::1

# ç¦æ­¢æ—¶é—´ (ç§’)
bantime = 3600

# æ£€æŸ¥æ—¶é—´çª—å£ (ç§’)
findtime = 600

# æœ€å¤§é‡è¯•æ¬¡æ•°
maxretry = 3

# åç«¯ç±»å‹
backend = auto

# é‚®ä»¶è®¾ç½® (å¯é€‰)
# destemail = admin@example.com
# sender = fail2ban@example.com
# mta = sendmail

[sshd]
enabled = true
port = $(get_ssh_config_value "port" "22")
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600

[nginx-http-auth]
enabled = false
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 3

[nginx-noscript]
enabled = false
filter = nginx-noscript
logpath = /var/log/nginx/access.log
maxretry = 6

[nginx-badbots]
enabled = false
filter = nginx-badbots
logpath = /var/log/nginx/access.log
maxretry = 2

[nginx-noproxy]
enabled = false
filter = nginx-noproxy
logpath = /var/log/nginx/access.log
maxretry = 2
EOF
    
    # å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
    systemctl enable fail2ban
    systemctl restart fail2ban
    
    success_msg "fail2banå…¥ä¾µé˜²æŠ¤é…ç½®å®Œæˆ"
    
    # æ˜¾ç¤ºçŠ¶æ€
    echo
    echo -e "${cyan}fail2bançŠ¶æ€:${white}"
    fail2ban-client status
}

configure_firewall() {
    clear
    echo -e "${cyan}=== é˜²ç«å¢™é…ç½® ===${white}"
    echo
    
    echo "é˜²ç«å¢™é…ç½®é€‰é¡¹:"
    echo "1. é…ç½®UFWé˜²ç«å¢™ (æ¨è)"
    echo "2. é…ç½®fail2banå…¥ä¾µé˜²æŠ¤"
    echo "3. å®Œæ•´é˜²ç«å¢™é…ç½® (UFW + fail2ban)"
    echo "4. ä»…æ˜¾ç¤ºå½“å‰çŠ¶æ€"
    echo
    
    local choice
    read -p "è¯·é€‰æ‹© [1-4]: " choice
    
    case $choice in
        1)
            configure_ufw_firewall
            ;;
        2)
            configure_fail2ban
            ;;
        3)
            configure_ufw_firewall
            echo
            configure_fail2ban
            ;;
        4)
            show_firewall_status
            ;;
        *)
            warn_msg "æ— æ•ˆé€‰æ‹©"
            return 1
            ;;
    esac
}

show_firewall_status() {
    echo -e "${cyan}=== é˜²ç«å¢™çŠ¶æ€ ===${white}"
    echo
    
    # UFWçŠ¶æ€
    if command -v ufw >/dev/null 2>&1; then
        echo -e "${cyan}UFWçŠ¶æ€:${white}"
        ufw status verbose
        echo
    fi
    
    # fail2bançŠ¶æ€
    if command -v fail2ban-client >/dev/null 2>&1; then
        echo -e "${cyan}fail2bançŠ¶æ€:${white}"
        systemctl is-active fail2ban
        fail2ban-client status 2>/dev/null || echo "fail2banæœªè¿è¡Œ"
        echo
    fi
    
    # iptablesè§„åˆ™æ‘˜è¦
    if command -v iptables >/dev/null 2>&1; then
        echo -e "${cyan}iptablesè§„åˆ™æ‘˜è¦:${white}"
        iptables -L INPUT -n --line-numbers | head -10
    fi
}
#endregion

#region //ç³»ç»ŸåŠ å›ºæ¨¡å—
harden_kernel_parameters() {
    info_msg "åŠ å›ºå†…æ ¸å‚æ•°..."
    
    backup_file "/etc/sysctl.conf"
    
    cat > /etc/sysctl.d/99-security-hardening.conf << EOF
# VPSå®‰å…¨åŠ å›º - å†…æ ¸å‚æ•°ä¼˜åŒ–
# ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')

# === ç½‘ç»œå®‰å…¨è®¾ç½® ===
# ç¦ç”¨IPv4è½¬å‘ (é™¤ééœ€è¦è·¯ç”±åŠŸèƒ½)
net.ipv4.ip_forward = 0

# ç¦ç”¨IPv6è½¬å‘
net.ipv6.conf.all.forwarding = 0

# ç¦ç”¨ICMPé‡å®šå‘
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# ç¦ç”¨å‘é€ICMPé‡å®šå‘
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# ç¦ç”¨æºè·¯ç”±
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# å¯ç”¨æºåœ°å€éªŒè¯
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# å¿½ç•¥ICMP pingè¯·æ±‚ (å¯é€‰)
# net.ipv4.icmp_echo_ignore_all = 1

# å¿½ç•¥å¹¿æ’­pingè¯·æ±‚
net.ipv4.icmp_echo_ignore_broadcasts = 1

# å¿½ç•¥é”™è¯¯ICMPå“åº”
net.ipv4.icmp_ignore_bogus_error_responses = 1

# TCP SYN cookiesé˜²æŠ¤
net.ipv4.tcp_syncookies = 1

# è®°å½•å¯ç–‘æ•°æ®åŒ…
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# === å†…å­˜ä¿æŠ¤ ===
# ç¦ç”¨magic SysRqé”®
kernel.sysrq = 0

# é™åˆ¶dmesgè®¿é—®
kernel.dmesg_restrict = 1

# é™åˆ¶å†…æ ¸æŒ‡é’ˆæ³„éœ²
kernel.kptr_restrict = 2

# === æ–‡ä»¶ç³»ç»Ÿå®‰å…¨ ===
# é™åˆ¶æ ¸å¿ƒè½¬å‚¨
fs.suid_dumpable = 0

# è¿›ç¨‹åœ°å€ç©ºé—´éšæœºåŒ–
kernel.randomize_va_space = 2

# === ç½‘ç»œæ€§èƒ½ä¼˜åŒ– ===
# TCPçª—å£ç¼©æ”¾
net.ipv4.tcp_window_scaling = 1

# TCPæ—¶é—´æˆ³
net.ipv4.tcp_timestamps = 1

# TCP SACK
net.ipv4.tcp_sack = 1

# TCPå¿«é€Ÿæ‰“å¼€ (è°¨æ…å¯ç”¨)
# net.ipv4.tcp_fastopen = 3

# ç½‘ç»œç¼“å†²åŒºå¤§å°
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728

# è¿æ¥é˜Ÿåˆ—å¤§å°
net.core.somaxconn = 32768
net.core.netdev_max_backlog = 32768

# TCPè¿æ¥å‚æ•°
net.ipv4.tcp_max_syn_backlog = 32768
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_keepalive_time = 600
EOF
    
    # åº”ç”¨è®¾ç½®
    sysctl -p /etc/sysctl.d/99-security-hardening.conf >/dev/null 2>&1
    
    success_msg "å†…æ ¸å‚æ•°åŠ å›ºå®Œæˆ"
}

configure_user_limits() {
    info_msg "é…ç½®ç”¨æˆ·èµ„æºé™åˆ¶..."
    
    backup_file "/etc/security/limits.conf"
    
    cat > /etc/security/limits.d/99-security-hardening.conf << EOF
# VPSå®‰å…¨åŠ å›º - ç”¨æˆ·èµ„æºé™åˆ¶
# ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')

# æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
* soft nofile 65535
* hard nofile 65535
root soft nofile 65535
root hard nofile 65535

# è¿›ç¨‹æ•°é™åˆ¶
* soft nproc 32768
* hard nproc 32768

# å†…å­˜é”å®šé™åˆ¶
* soft memlock unlimited
* hard memlock unlimited

# æ ˆå¤§å°é™åˆ¶
* soft stack 8192
* hard stack 8192
EOF
    
    success_msg "ç”¨æˆ·èµ„æºé™åˆ¶é…ç½®å®Œæˆ"
}

disable_unnecessary_services() {
    info_msg "ç¦ç”¨ä¸å¿…è¦çš„ç³»ç»ŸæœåŠ¡..."
    
    # å¸¸è§çš„å¯ä»¥ç¦ç”¨çš„æœåŠ¡åˆ—è¡¨
    local services_to_disable=(
        "avahi-daemon"      # ç½‘ç»œå‘ç°æœåŠ¡
        "cups"              # æ‰“å°æœåŠ¡
        "bluetooth"         # è“ç‰™æœåŠ¡
        "ModemManager"      # è°ƒåˆ¶è§£è°ƒå™¨ç®¡ç†
        "whoopsie"          # Ubuntué”™è¯¯æŠ¥å‘Š
        "apport"            # Ubuntuå´©æºƒæŠ¥å‘Š
    )
    
    for service in "${services_to_disable[@]}"; do
        if systemctl is-enabled "$service" >/dev/null 2>&1; then
            systemctl disable "$service" >/dev/null 2>&1
            systemctl stop "$service" >/dev/null 2>&1
            success_msg "å·²ç¦ç”¨æœåŠ¡: $service"
        fi
    done
    
    success_msg "ä¸å¿…è¦æœåŠ¡ç¦ç”¨å®Œæˆ"
}

configure_automatic_updates() {
    info_msg "é…ç½®è‡ªåŠ¨å®‰å…¨æ›´æ–°..."
    
    case $PACKAGE_MANAGER in
        apt)
            # å®‰è£…unattended-upgrades
            apt update -qq && apt install -y unattended-upgrades
            
            # é…ç½®è‡ªåŠ¨æ›´æ–°
            cat > /etc/apt/apt.conf.d/50unattended-upgrades << EOF
// VPSå®‰å…¨åŠ å›º - è‡ªåŠ¨æ›´æ–°é…ç½®
Unattended-Upgrade::Allowed-Origins {
    "\${distro_id}:\${distro_codename}-security";
    "\${distro_id}ESMApps:\${distro_codename}-apps-security";
    "\${distro_id}ESM:\${distro_codename}-infra-security";
};

Unattended-Upgrade::AutoFixInterruptedDpkg "true";
Unattended-Upgrade::MinimalSteps "true";
Unattended-Upgrade::Remove-Unused-Dependencies "true";
Unattended-Upgrade::Automatic-Reboot "false";
Unattended-Upgrade::Automatic-Reboot-Time "02:00";
EOF
            
            cat > /etc/apt/apt.conf.d/20auto-upgrades << EOF
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Unattended-Upgrade "1";
APT::Periodic::Download-Upgradeable-Packages "1";
APT::Periodic::AutocleanInterval "7";
EOF
            
            # å¯ç”¨æœåŠ¡
            systemctl enable unattended-upgrades
            systemctl start unattended-upgrades
            ;;
            
        yum|dnf)
            # å®‰è£…yum-cronæˆ–dnf-automatic
            if [[ "$PACKAGE_MANAGER" == "dnf" ]]; then
                dnf install -y dnf-automatic
                systemctl enable dnf-automatic.timer
                systemctl start dnf-automatic.timer
            else
                yum install -y yum-cron
                systemctl enable yum-cron
                systemctl start yum-cron
            fi
            ;;
    esac
    
    success_msg "è‡ªåŠ¨å®‰å…¨æ›´æ–°é…ç½®å®Œæˆ"
}

system_hardening() {
    clear
    echo -e "${cyan}=== ç³»ç»Ÿå®‰å…¨åŠ å›º ===${white}"
    echo
    
    echo "ç³»ç»ŸåŠ å›ºé€‰é¡¹:"
    echo "1. å†…æ ¸å‚æ•°åŠ å›º"
    echo "2. ç”¨æˆ·èµ„æºé™åˆ¶"
    echo "3. ç¦ç”¨ä¸å¿…è¦æœåŠ¡"
    echo "4. é…ç½®è‡ªåŠ¨æ›´æ–°"
    echo "5. å®Œæ•´ç³»ç»ŸåŠ å›º"
    echo
    
    local choice
    read -p "è¯·é€‰æ‹© [1-5]: " choice
    
    case $choice in
        1)
            harden_kernel_parameters
            ;;
        2)
            configure_user_limits
            ;;
        3)
            disable_unnecessary_services
            ;;
        4)
            configure_automatic_updates
            ;;
        5)
            info_msg "æ‰§è¡Œå®Œæ•´ç³»ç»ŸåŠ å›º..."
            harden_kernel_parameters
            configure_user_limits
            disable_unnecessary_services
            configure_automatic_updates
            success_msg "å®Œæ•´ç³»ç»ŸåŠ å›ºå®Œæˆ"
            ;;
        *)
            warn_msg "æ— æ•ˆé€‰æ‹©"
            return 1
            ;;
    esac
}
#endregion

#region //å®‰å…¨å®¡è®¡æ¨¡å—
security_audit() {
    clear
    echo -e "${cyan}=== ç³»ç»Ÿå®‰å…¨å®¡è®¡ ===${white}"
    echo
    
    local total_issues=0
    
    # SSHå®‰å…¨å®¡è®¡
    echo -e "${pink}SSHå®‰å…¨æ£€æŸ¥:${white}"
    ssh_security_audit
    total_issues=$((total_issues + $?))
    echo
    
    # é˜²ç«å¢™æ£€æŸ¥
    echo -e "${pink}é˜²ç«å¢™æ£€æŸ¥:${white}"
    if command -v ufw >/dev/null 2>&1; then
        local ufw_status=$(ufw status | head -1 | grep -o "Status: [a-z]*" | cut -d: -f2 | xargs)
        if [[ "$ufw_status" == "active" ]]; then
            echo -e "${green}âœ“ UFWé˜²ç«å¢™å·²å¯ç”¨${white}"
        else
            echo -e "${red}âœ— UFWé˜²ç«å¢™æœªå¯ç”¨${white}"
            ((total_issues++))
        fi
    else
        echo -e "${yellow}âš  UFWé˜²ç«å¢™æœªå®‰è£…${white}"
    fi
    
    if command -v fail2ban-client >/dev/null 2>&1; then
        if systemctl is-active fail2ban >/dev/null 2>&1; then
            echo -e "${green}âœ“ fail2banå…¥ä¾µé˜²æŠ¤å·²å¯ç”¨${white}"
        else
            echo -e "${red}âœ— fail2banå…¥ä¾µé˜²æŠ¤æœªè¿è¡Œ${white}"
            ((total_issues++))
        fi
    else
        echo -e "${yellow}âš  fail2banå…¥ä¾µé˜²æŠ¤æœªå®‰è£…${white}"
    fi
    echo
    
    # ç³»ç»Ÿæ›´æ–°æ£€æŸ¥
    echo -e "${pink}ç³»ç»Ÿæ›´æ–°æ£€æŸ¥:${white}"
    case $PACKAGE_MANAGER in
        apt)
            local updates=$(apt list --upgradable 2>/dev/null | wc -l)
            if [[ $updates -gt 1 ]]; then
                echo -e "${yellow}âš  æœ‰ $((updates-1)) ä¸ªè½¯ä»¶åŒ…éœ€è¦æ›´æ–°${white}"
            else
                echo -e "${green}âœ“ ç³»ç»Ÿè½¯ä»¶åŒ…å·²æ˜¯æœ€æ–°${white}"
            fi
            
            if systemctl is-active unattended-upgrades >/dev/null 2>&1; then
                echo -e "${green}âœ“ è‡ªåŠ¨æ›´æ–°æœåŠ¡å·²å¯ç”¨${white}"
            else
                echo -e "${yellow}âš  è‡ªåŠ¨æ›´æ–°æœåŠ¡æœªå¯ç”¨${white}"
            fi
            ;;
        yum|dnf)
            if systemctl is-active yum-cron >/dev/null 2>&1 || systemctl is-active dnf-automatic.timer >/dev/null 2>&1; then
                echo -e "${green}âœ“ è‡ªåŠ¨æ›´æ–°æœåŠ¡å·²å¯ç”¨${white}"
            else
                echo -e "${yellow}âš  è‡ªåŠ¨æ›´æ–°æœåŠ¡æœªå¯ç”¨${white}"
            fi
            ;;
    esac
    echo
    
    # æ–‡ä»¶æƒé™æ£€æŸ¥
    echo -e "${pink}å…³é”®æ–‡ä»¶æƒé™æ£€æŸ¥:${white}"
    local sensitive_files=(
        "/etc/passwd:644"
        "/etc/shadow:640"
        "/etc/ssh/sshd_config:644"
        "/root:700"
    )
    
    for file_perm in "${sensitive_files[@]}"; do
        local file="${file_perm%:*}"
        local expected_perm="${file_perm#*:}"
        
        if [[ -e "$file" ]]; then
            local actual_perm=$(stat -c '%a' "$file")
            if [[ "$actual_perm" == "$expected_perm" ]]; then
                echo -e "${green}âœ“ $file æƒé™æ­£ç¡® ($actual_perm)${white}"
            else
                echo -e "${red}âœ— $file æƒé™å¼‚å¸¸: $actual_perm (åº”ä¸º $expected_perm)${white}"
                ((total_issues++))
            fi
        fi
    done
    echo
    
    # è¿è¡Œè¿›ç¨‹æ£€æŸ¥
    echo -e "${pink}å¯ç–‘è¿›ç¨‹æ£€æŸ¥:${white}"
    local suspicious_processes=(
        "bitcoin"
        "monero"
        "xmrig"
        "cryptonight"
        "stratum"
    )
    
    local found_suspicious=false
    for process in "${suspicious_processes[@]}"; do
        if pgrep -f "$process" >/dev/null 2>&1; then
            echo -e "${red}âœ— å‘ç°å¯ç–‘è¿›ç¨‹: $process${white}"
            ((total_issues++))
            found_suspicious=true
        fi
    done
    
    if [[ "$found_suspicious" == "false" ]]; then
        echo -e "${green}âœ“ æœªå‘ç°å¯ç–‘è¿›ç¨‹${white}"
    fi
    echo
    
    # å®¡è®¡æ€»ç»“
    echo -e "${cyan}=== å®‰å…¨å®¡è®¡æ€»ç»“ ===${white}"
    if [[ $total_issues -eq 0 ]]; then
        echo -e "${green}âœ“ å®‰å…¨å®¡è®¡é€šè¿‡ï¼Œæœªå‘ç°ä¸¥é‡é—®é¢˜${white}"
    else
        echo -e "${yellow}å‘ç° $total_issues ä¸ªå®‰å…¨é—®é¢˜ï¼Œå»ºè®®è¿›è¡Œä¿®å¤${white}"
    fi
    echo
    
    return $total_issues
}
#endregion

#region //ä¸»èœå•ç³»ç»Ÿ
show_system_status() {
    clear
    echo -e "${pink}=== ç³»ç»ŸçŠ¶æ€æ€»è§ˆ ===${white}"
    echo
    
    # ç³»ç»Ÿä¿¡æ¯
    echo -e "${cyan}ç³»ç»Ÿä¿¡æ¯:${white}"
    echo "  æ“ä½œç³»ç»Ÿ: $(lsb_release -d 2>/dev/null | cut -d: -f2 | xargs || cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '\"')"
    echo "  å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
    echo "  è¿è¡Œæ—¶é—´: $(uptime -p 2>/dev/null || uptime | awk -F'up ' '{print $2}' | awk -F', load' '{print $1}')"
    echo "  ç³»ç»Ÿè´Ÿè½½: $(uptime | awk -F'load average:' '{print $2}')"
    echo
    
    # SSHçŠ¶æ€
    echo -e "${cyan}SSHçŠ¶æ€:${white}"
    if systemctl is-active sshd >/dev/null 2>&1 || systemctl is-active ssh >/dev/null 2>&1; then
        echo "  æœåŠ¡çŠ¶æ€: ${green}è¿è¡Œä¸­${white}"
        echo "  ç›‘å¬ç«¯å£: $(get_ssh_config_value 'port' '22')"
        echo "  Rootç™»å½•: $(get_ssh_config_value 'permitrootlogin' 'æœªçŸ¥')"
        echo "  å¯†ç è®¤è¯: $(get_ssh_config_value 'passwordauthentication' 'æœªçŸ¥')"
    else
        echo "  æœåŠ¡çŠ¶æ€: ${red}æœªè¿è¡Œ${white}"
    fi
    echo
    
    # å®‰å…¨çŠ¶æ€
    echo -e "${cyan}å®‰å…¨çŠ¶æ€:${white}"
    
    # é˜²ç«å¢™çŠ¶æ€
    if command -v ufw >/dev/null 2>&1; then
        local ufw_status=$(ufw status | head -1 | cut -d: -f2 | xargs)
        echo "  UFWé˜²ç«å¢™: ${green}$ufw_status${white}"
    else
        echo "  UFWé˜²ç«å¢™: ${yellow}æœªå®‰è£…${white}"
    fi
    
    # fail2bançŠ¶æ€
    if command -v fail2ban-client >/dev/null 2>&1; then
        if systemctl is-active fail2ban >/dev/null 2>&1; then
            echo "  fail2ban: ${green}è¿è¡Œä¸­${white}"
        else
            echo "  fail2ban: ${red}æœªè¿è¡Œ${white}"
        fi
    else
        echo "  fail2ban: ${yellow}æœªå®‰è£…${white}"
    fi
    
    # è‡ªåŠ¨æ›´æ–°çŠ¶æ€
    if systemctl is-enabled unattended-upgrades >/dev/null 2>&1; then
        echo "  è‡ªåŠ¨æ›´æ–°: ${green}å·²å¯ç”¨${white}"
    elif systemctl is-enabled yum-cron >/dev/null 2>&1 || systemctl is-enabled dnf-automatic.timer >/dev/null 2>&1; then
        echo "  è‡ªåŠ¨æ›´æ–°: ${green}å·²å¯ç”¨${white}"
    else
        echo "  è‡ªåŠ¨æ›´æ–°: ${yellow}æœªå¯ç”¨${white}"
    fi
    echo
    
    # èµ„æºä½¿ç”¨æƒ…å†µ
    echo -e "${cyan}èµ„æºä½¿ç”¨æƒ…å†µ:${white}"
    echo "  CPUä½¿ç”¨ç‡: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d% -f1)%"
    echo "  å†…å­˜ä½¿ç”¨: $(free | grep Mem | awk '{printf "%.1f%%", $3/$2 * 100.0}')"
    echo "  ç£ç›˜ä½¿ç”¨: $(df / | tail -1 | awk '{print $5}')"
    echo "  ç½‘ç»œè¿æ¥: $(ss -tun | wc -l) ä¸ªæ´»åŠ¨è¿æ¥"
    echo
}

show_help() {
    clear
    echo -e "${pink}=== VPSå®‰å…¨åŠ å›ºå·¥å…· v$version ===${white}"
    echo
    echo "ä¸“æ³¨äºVPSæœåŠ¡å™¨å®‰å…¨åŠ å›ºçš„ä¸“ä¸šå·¥å…·"
    echo
    echo "ç”¨æ³•: $0 [é€‰é¡¹]"
    echo
    echo "å¿«é€Ÿæ“ä½œé€‰é¡¹:"
    echo "  --help, -h        æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo "  --version, -v     æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo "  --ssh             å¿«é€ŸSSHå®‰å…¨é…ç½®"
    echo "  --firewall        å¿«é€Ÿé˜²ç«å¢™é…ç½®"
    echo "  --harden          ç³»ç»Ÿå®‰å…¨åŠ å›º"
    echo "  --audit           å®‰å…¨å®¡è®¡æ£€æŸ¥"
    echo "  --status          æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€"
    echo "  --full            å®Œæ•´å®‰å…¨åŠ å›º"
    echo
    echo "ä¸»è¦åŠŸèƒ½:"
    echo "  â€¢ SSHå®‰å…¨é…ç½®ä¸å¯†é’¥ç®¡ç†"
    echo "  â€¢ UFWé˜²ç«å¢™é…ç½®"
    echo "  â€¢ fail2banå…¥ä¾µé˜²æŠ¤"
    echo "  â€¢ ç³»ç»Ÿå†…æ ¸å‚æ•°åŠ å›º"
    echo "  â€¢ è‡ªåŠ¨å®‰å…¨æ›´æ–°é…ç½®"
    echo "  â€¢ å…¨é¢å®‰å…¨å®¡è®¡æ£€æŸ¥"
    echo
    echo "æ”¯æŒç³»ç»Ÿ: Ubuntu, Debian, CentOS, RHEL, Fedora"
    echo
}

main_menu() {
    while true; do
        clear
        echo -e "${pink}${bold}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${white}"
        echo -e "${pink}${bold}â•‘        VPSå®‰å…¨åŠ å›ºå·¥å…· v$version         â•‘${white}"
        echo -e "${pink}${bold}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${white}"
        echo
        echo -e "${cyan}ğŸ›¡ï¸  SSHå®‰å…¨:${white}"
        echo "  1. SSHå®‰å…¨é…ç½®"
        echo "  2. SSHå®‰å…¨å®¡è®¡"
        echo "  3. SSHå¯†é’¥ç®¡ç†"
        echo
        echo -e "${cyan}ğŸ”¥ é˜²ç«å¢™é˜²æŠ¤:${white}"
        echo "  4. é˜²ç«å¢™é…ç½®"
        echo "  5. å…¥ä¾µé˜²æŠ¤ (fail2ban)"
        echo "  6. é˜²ç«å¢™çŠ¶æ€"
        echo
        echo -e "${cyan}âš¡ ç³»ç»ŸåŠ å›º:${white}"
        echo "  7. å†…æ ¸å‚æ•°åŠ å›º"
        echo "  8. ç³»ç»ŸæœåŠ¡ç®¡ç†"
        echo "  9. è‡ªåŠ¨æ›´æ–°é…ç½®"
        echo
        echo -e "${cyan}ğŸ“Š å®‰å…¨ç®¡ç†:${white}"
        echo "  10. ç³»ç»ŸçŠ¶æ€"
        echo "  11. å®‰å…¨å®¡è®¡"
        echo "  12. å®Œæ•´åŠ å›º"
        echo
        echo -e "${cyan}â„¹ï¸  å…¶ä»–:${white}"
        echo "  13. å¸®åŠ©ä¿¡æ¯"
        echo "  0. é€€å‡º"
        echo
        
        local choice
        read -p "è¯·é€‰æ‹© [0-13]: " choice
        
        case $choice in
            1) configure_ssh_security ;;
            2) ssh_security_audit; read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n 1 -s ;;
            3) 
                echo
                echo "SSHå¯†é’¥ç®¡ç†:"
                echo "1. ç”ŸæˆED25519å¯†é’¥"
                echo "2. ç”ŸæˆRSAå¯†é’¥"
                read -p "è¯·é€‰æ‹© [1-2]: " key_choice
                case $key_choice in
                    1) generate_ssh_keys "ed25519" ;;
                    2) generate_ssh_keys "rsa" ;;
                esac
                read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n 1 -s
                ;;
            4) configure_firewall ;;
            5) configure_fail2ban; read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n 1 -s ;;
            6) show_firewall_status; read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n 1 -s ;;
            7) harden_kernel_parameters; read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n 1 -s ;;
            8) disable_unnecessary_services; read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n 1 -s ;;
            9) configure_automatic_updates; read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n 1 -s ;;
            10) show_system_status; read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n 1 -s ;;
            11) security_audit; read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n 1 -s ;;
            12) full_security_hardening ;;
            13) show_help; read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n 1 -s ;;
            0) 
                echo -e "${green}æ„Ÿè°¢ä½¿ç”¨VPSå®‰å…¨åŠ å›ºå·¥å…·ï¼${white}"
                exit 0
                ;;
            *)
                warn_msg "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°é€‰æ‹©"
                sleep 1
                ;;
        esac
    done
}

full_security_hardening() {
    clear
    echo -e "${cyan}=== å®Œæ•´å®‰å…¨åŠ å›ºæµç¨‹ ===${white}"
    echo "æ­¤æ“ä½œå°†æ‰§è¡Œå®Œæ•´çš„VPSå®‰å…¨åŠ å›ºï¼ŒåŒ…æ‹¬ï¼š"
    echo "â€¢ SSHå®‰å…¨é…ç½®"
    echo "â€¢ é˜²ç«å¢™é…ç½®"
    echo "â€¢ å…¥ä¾µé˜²æŠ¤"
    echo "â€¢ ç³»ç»Ÿå†…æ ¸åŠ å›º"
    echo "â€¢ è‡ªåŠ¨æ›´æ–°é…ç½®"
    echo
    
    read -p "ç¡®è®¤æ‰§è¡Œå®Œæ•´å®‰å…¨åŠ å›ºï¼Ÿ(y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        info_msg "å¼€å§‹å®Œæ•´å®‰å…¨åŠ å›ºæµç¨‹..."
        
        # 1. SSHå®‰å…¨é…ç½®
        echo
        echo "=== ç¬¬1æ­¥: SSHå®‰å…¨é…ç½® ==="
        configure_ssh_security
        
        # 2. é˜²ç«å¢™é…ç½®
        echo
        echo "=== ç¬¬2æ­¥: é˜²ç«å¢™é…ç½® ==="
        configure_ufw_firewall
        
        # 3. å…¥ä¾µé˜²æŠ¤
        echo
        echo "=== ç¬¬3æ­¥: å…¥ä¾µé˜²æŠ¤é…ç½® ==="
        configure_fail2ban
        
        # 4. ç³»ç»ŸåŠ å›º
        echo
        echo "=== ç¬¬4æ­¥: ç³»ç»Ÿå‚æ•°åŠ å›º ==="
        harden_kernel_parameters
        configure_user_limits
        
        # 5. æœåŠ¡ä¼˜åŒ–
        echo
        echo "=== ç¬¬5æ­¥: æœåŠ¡ä¼˜åŒ– ==="
        disable_unnecessary_services
        
        # 6. è‡ªåŠ¨æ›´æ–°
        echo
        echo "=== ç¬¬6æ­¥: è‡ªåŠ¨æ›´æ–°é…ç½® ==="
        configure_automatic_updates
        
        echo
        success_msg "å®Œæ•´å®‰å…¨åŠ å›ºæµç¨‹å·²å®Œæˆï¼"
        echo
        echo "å»ºè®®ç«‹å³æ‰§è¡Œå®‰å…¨å®¡è®¡æ£€æŸ¥é…ç½®æ•ˆæœ"
        read -p "æ˜¯å¦ç°åœ¨æ‰§è¡Œå®‰å…¨å®¡è®¡ï¼Ÿ(Y/n): " audit_confirm
        if [[ ! "$audit_confirm" =~ ^[Nn]$ ]]; then
            echo
            security_audit
        fi
    fi
    
    read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n 1 -s
}
#endregion

#region //ä¸»ç¨‹åºå…¥å£
handle_arguments() {
    case "${1:-}" in
        --help|-h)
            show_help
            exit 0
            ;;
        --version|-v)
            echo "VPSå®‰å…¨åŠ å›ºå·¥å…· v$version"
            exit 0
            ;;
        --ssh)
            configure_ssh_security
            exit 0
            ;;
        --firewall)
            configure_firewall
            exit 0
            ;;
        --harden)
            system_hardening
            exit 0
            ;;
        --audit)
            security_audit
            exit 0
            ;;
        --status)
            show_system_status
            exit 0
            ;;
        --full)
            full_security_hardening
            exit 0
            ;;
        "")
            # æ— å‚æ•°ï¼Œè¿›å…¥äº¤äº’æ¨¡å¼
            ;;
        *)
            echo "æœªçŸ¥å‚æ•°: $1"
            echo "ä½¿ç”¨ --help æŸ¥çœ‹å¸®åŠ©"
            exit 1
            ;;
    esac
}

main() {
    # æ£€æŸ¥æƒé™
    check_root_permission
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    create_directories
    
    # å¤„ç†å‘½ä»¤è¡Œå‚æ•°
    handle_arguments "$@"
    
    # æ£€æµ‹ç³»ç»Ÿ
    detect_system
    
    # è®°å½•å¯åŠ¨
    log_operation "VPSå®‰å…¨åŠ å›ºå·¥å…· v$version å¯åŠ¨"
    
    # è¿›å…¥ä¸»èœå•
    main_menu
}

# è„šæœ¬æ‰§è¡Œå…¥å£
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
#endregion