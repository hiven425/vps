# VLESS Reality 终极部署脚本 v6.0.0

一个专业级的 VLESS Reality 代理服务部署和管理脚本，具备智能证书处理、详细诊断、完全幂等性和用户友好的交互界面。

## 🎯 核心特性

### 🧠 智能证书处理
- **状态码检测**: 精确处理 acme.sh 的不同退出状态（0=成功，2=跳过，其他=错误）
- **用户友好沟通**: 明确告知用户"跳过续期是正确的行为"，消除困惑
- **强制模式**: 支持 `--force` 参数强制重新申请证书
- **自动安装**: 无论申请结果如何，都会执行证书安装流程

### 🔍 详细失败诊断
- **自动日志显示**: 服务启动失败时自动显示 `journalctl -u service -n 20`
- **配置验证**: 启动前检查 Nginx 和 Xray 配置文件语法
- **端口监听检查**: 验证 443 端口监听状态
- **证书文件验证**: 检查证书文件存在性和有效期

### 🔄 完全幂等性
- **安全重复运行**: 可多次执行而不会破坏现有配置
- **智能跳过**: 自动跳过已完成的步骤和有效的证书
- **配置保护**: 保护现有的服务配置和用户数据

### 🎨 用户友好界面
- **步骤进度**: 清晰的步骤显示（步骤 1/11 到 11/11）
- **状态反馈**: 详细的操作状态和验证结果
- **颜色编码**: 美观的界面设计和信息分类
- **帮助系统**: 内置帮助信息和使用说明

## 📁 项目结构

```
vps/
├── setup.sh                      # VLESS Reality 终极部署脚本
└── README.md                     # 项目文档 (本文件)
```

**简洁设计**: 只有两个文件，便于 VPS 部署和管理。

## 🔧 功能模块

### 主要功能
1. **首次安装或完整重装服务** - 完整的 VLESS Reality 部署流程
2. **修改服务配置** - 域名、UUID、密钥等配置管理
3. **安全与防火墙管理** - Fail2ban 和 UFW 防火墙配置
4. **检查服务运行状态** - 详细的服务状态监控
5. **查看客户端连接信息** - 生成和显示连接配置
6. **卸载服务** - 完整的服务卸载和清理
7. **修改SSH端口** - SSH 安全配置管理
8. **退出** - 安全退出脚本

### 配置管理功能
- **更换主域名**: 申请新证书并更新所有相关配置
- **更换伪装域名**: 更新 Nginx 反向代理配置
- **重新生成 UUID**: 生成新的用户标识符
- **重新生成 Reality 密钥对**: 更新加密密钥
- **重新生成 ShortId**: 更新短标识符

## 🚀 快速开始

### 系统要求
- **操作系统**: Debian/Ubuntu (推荐 Ubuntu 20.04+)
- **权限**: Root 用户权限
- **网络**: 稳定的互联网连接
- **域名**: 已解析到服务器的域名
- **Cloudflare**: Cloudflare API Token（用于 DNS 验证）

### 基本使用

#### 1. 查看帮助信息
```bash
bash setup.sh --help
```

#### 2. 正常部署（推荐）
```bash
bash setup.sh
```
- 智能检测现有证书，避免不必要的申请
- 完全幂等性，可安全重复运行
- 详细的进度显示和状态反馈

#### 3. 强制重新申请证书
```bash
bash setup.sh --force
```
- 强制重新申请所有证书
- 适用于证书测试和问题排查
- 忽略现有证书的有效期

## 🔍 智能证书处理详解

### 证书状态检测
脚本会智能检测 `acme.sh` 的退出状态码：

| 状态码 | 含义 | 脚本行为 | 用户看到的信息 |
|--------|------|----------|----------------|
| 0 | 新证书申请成功 | 继续安装证书 | `[SUCCESS] 新证书已成功签发！` |
| 2 | 证书已存在且有效 | 继续安装证书 | `[INFO] 证书已存在且在有效期内。跳过续期是正确的行为。` |
| 其他 | 申请失败 | 显示错误和诊断 | `[ERROR] 证书申请失败，状态码: X` |

### 用户友好的消息示例

#### 正常跳过（不是错误）
```
[INFO] 正在检查并申请 SSL 证书...
[INFO] 证书已存在且在有效期内。跳过续期是正确的行为。
[INFO] 这不是错误 - acme.sh 智能地避免了不必要的证书申请。
[SUCCESS] 证书已成功配置给 Nginx。
```

#### 真正的错误
```
[ERROR] 证书申请失败，状态码: 1
[ERROR] 请检查以下可能的原因：
[ERROR] 1. Cloudflare API Token 是否正确
[ERROR] 2. 域名 DNS 是否指向 Cloudflare
[ERROR] 3. 网络连接是否正常
[INFO] 详细错误信息请查看: /root/.acme.sh/acme.sh.log
```

## ⚠️ 已知交互逻辑缺陷

经过深入分析，发现脚本存在以下交互逻辑缺陷，需要在使用时注意：

### 1. 颜色变量定义顺序问题
**问题描述**: `show_usage()` 函数在颜色变量定义之前使用了 `${CYAN}`、`${WHITE}`、`${NC}` 等变量
**影响**: 帮助信息显示时颜色变量为空，影响显示效果
**位置**: 第14-31行（show_usage函数）vs 第47-50行（颜色定义）
**临时解决**: 功能正常，仅影响显示美观

### 2. set -e 与交互菜单的严重冲突
**问题描述**: 脚本开头设置了 `set -e`（遇到错误立即退出），但在交互菜单中使用了 `check_result()` 函数
**影响**: 如果在菜单操作中遇到任何错误（如服务重启失败），整个脚本会立即退出，用户无法返回主菜单
**风险等级**: 高
**具体场景**: 
- 域名更换时证书申请失败
- 服务重启失败
- 配置文件语法错误

### 3. load_config 函数使用不一致
**问题描述**: `load_config()` 函数在配置文件不存在时返回 1，在 `set -e` 环境下可能导致意外退出
**影响**: 部分功能可能无法正常处理配置文件不存在的情况
**使用模式不一致**:
- 有些地方使用 `if ! load_config; then`（正确）
- 有些地方使用 `if load_config; then`（可能有问题）
- 有些地方直接调用 `load_config`（危险）

### 4. 错误处理机制设计缺陷
**问题描述**: `check_result()` 函数直接调用 `exit 1`，不适合交互式环境
**建议改进**: 应该返回错误状态而不是直接退出，让调用者决定如何处理

## 🔧 建议的修复方案

### 短期解决方案
1. **谨慎使用**: 在生产环境中谨慎使用菜单功能，优先使用首次安装功能
2. **备份配置**: 在进行任何配置更改前先备份
3. **分步操作**: 避免在一次会话中进行多个复杂操作

### 长期修复建议
1. **移除 set -e**: 在交互式脚本中不应使用 `set -e`
2. **重构错误处理**: 将 `check_result()` 改为返回状态码而非直接退出
3. **统一 load_config 使用**: 确保所有地方都正确处理配置文件不存在的情况
4. **修复颜色变量**: 将颜色定义移到脚本开头

## 🛠️ 故障排除

### 常见问题

#### Q: 为什么显示"跳过续期"？
A: 这是正常行为！说明您的证书仍然有效，acme.sh 智能地避免了不必要的申请。

#### Q: 如何强制重新申请证书？
A: 使用 `bash setup.sh --force` 命令。

#### Q: 脚本可以重复运行吗？
A: 是的！脚本具有完全幂等性，可以安全重复运行。

#### Q: 服务启动失败怎么办？
A: 脚本会自动显示详细的诊断信息，包括服务日志和配置验证结果。

#### Q: 在菜单操作中遇到错误脚本退出了怎么办？
A: 这是已知的交互逻辑缺陷。建议重新运行脚本，优先使用首次安装功能。

### 日志和诊断
```bash
# 查看 Xray 服务日志
journalctl -u xray -f

# 查看 Nginx 服务日志
journalctl -u nginx -f

# 检查服务状态
systemctl status xray nginx

# 验证配置文件
nginx -t
/usr/local/bin/xray test -config /usr/local/etc/xray/config.json

# 查看证书状态
openssl x509 -in /etc/ssl/private/fullchain.cer -text -noout
```

## 📋 技术细节

### 脚本架构
- **主程序**: `main()` 函数提供交互式菜单
- **功能模块**: 独立的功能函数，支持模块化调用
- **配置管理**: 统一的配置文件管理机制
- **错误处理**: 详细的错误检测和诊断功能

### 关键文件位置
```
/etc/setup/config.ini              # 主配置文件
/usr/local/etc/xray/config.json    # Xray 配置
/etc/nginx/nginx.conf               # Nginx 配置
/etc/ssl/private/                   # SSL 证书目录
/root/client-configs/               # 客户端配置
/root/vless-backups/                # 配置备份
```

### 服务管理
```bash
# 启动服务
systemctl start xray nginx

# 停止服务
systemctl stop xray nginx

# 重启服务
systemctl restart xray nginx

# 查看状态
systemctl status xray nginx

# 启用自启动
systemctl enable xray nginx
```

## 🔒 安全注意事项

1. **Root 权限**: 脚本需要 root 权限运行，请确保在可信环境中使用
2. **API Token**: Cloudflare API Token 具有敏感权限，请妥善保管
3. **配置备份**: 重要配置会自动备份到 `/root/vless-backups/`
4. **防火墙**: 脚本会自动配置 UFW 防火墙，请确保 SSH 端口不被误封
5. **证书安全**: SSL 证书私钥权限设置为 600，仅 root 可读

## 📚 参考资料

- **VLESS Protocol**: [Xray 官方文档](https://xtls.github.io/)
- **Reality Protocol**: [Reality 协议说明](https://github.com/XTLS/REALITY)
- **acme.sh**: [证书申请工具](https://github.com/acmesh-official/acme.sh)
- **Cloudflare API**: [API 文档](https://developers.cloudflare.com/api/)

---

**🎯 项目目标**: 提供最专业、最易用、最安全的 VLESS Reality 部署解决方案

**📧 技术支持**: 如有问题，请通过 GitHub Issues 联系我们

**⭐ 支持项目**: 如果这个项目对您有帮助，请给我们一个 Star！

**⚠️ 免责声明**: 本脚本仅供学习和研究使用，请遵守当地法律法规
