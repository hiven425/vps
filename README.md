# VPS安全加固与代理搭建工具

一个集成VPS安全加固和VLESS-HTTP2-REALITY代理部署的一体化脚本工具。

## 特性

### 🛡️ 安全加固
- **SSH安全配置**: 端口修改、密钥认证、安全参数优化
- **防火墙设置**: UFW/iptables配置、DDoS防护、IPv6支持
- **系统优化**: BBR拥塞控制、网络参数调优、文件描述符优化
- **入侵防护**: fail2ban自动封禁恶意IP
- **系统清理**: 自动清理系统垃圾文件

### 🚀 代理部署
- **VLESS-HTTP2-REALITY**: 最新的抗检测代理协议
- **自动配置**: 一键生成所有必要的配置参数
- **多平台支持**: 生成适配各种客户端的配置文件
- **IPv4/IPv6双栈**: 完整支持双栈网络环境
- **服务管理**: 完整的systemd服务管理

### 🎨 用户体验
- **彩色交互界面**: 清晰直观的操作界面
- **智能检测**: 自动检测系统环境和地理位置
- **进度显示**: 实时显示操作进度
- **错误处理**: 完善的错误处理和回滚机制
- **一键部署**: 全自动化部署流程

## 系统要求

### 支持的操作系统
- Ubuntu 18.04+
- Debian 9+
- CentOS 7+

### 系统要求
- Root权限
- 至少512MB内存
- 至少10GB磁盘空间
- 稳定的网络连接

## 项目结构

```
vps/
├── security-hardening.sh    # 主脚本 - VPS安全加固与代理部署一体化工具
├── README.md               # 项目说明文档
└── .gitignore             # Git忽略文件配置
```

**设计理念**: 采用单脚本架构，便于VPS部署和执行，所有功能集成在一个主脚本中，无需额外依赖文件。

## 快速开始

### 一键安装
```bash
# 下载并运行脚本
curl -sS -O https://raw.githubusercontent.com/hiven425/vps/security-hardening.sh
chmod +x security-hardening.sh
sudo ./security-hardening.sh
```

### 使用wget
```bash
wget https://raw.githubusercontent.com/your-repo/security-hardening.sh
chmod +x security-hardening.sh
sudo ./security-hardening.sh
```

### 命令行模式
```bash
# 显示帮助信息
./security-hardening.sh --help

# 一键部署所有功能
./security-hardening.sh --deploy

# 仅执行安全加固
./security-hardening.sh --security

# 仅执行代理部署
./security-hardening.sh --proxy

# 测试网络质量
./security-hardening.sh --test-network

# 显示系统状态
./security-hardening.sh --status

# 显示系统信息
./security-hardening.sh --info
```

## 功能说明

### 主菜单
```
VPS安全加固与代理搭建工具 v2.1.0
================================
1. 系统信息查询
2. 安全加固 ->
3. 代理部署 ->
4. 服务管理 ->
5. 配置管理 ->
6. 网络质量检测
7. 测试工具 ->
8. 批量操作模式
9. 快速工具安装 ->
================================
0. 一键部署（安全+代理）
================================
q. 退出脚本
```

### 安全加固模块
- **SSH安全配置**: 使用sshd_config.d目录，支持PermitRootLogin prohibit-password
- **SSH配置诊断**: 自动检测云服务商配置冲突，验证配置有效性
- **防火墙设置**: 配置防火墙规则，开放必要端口，启用DDoS防护
- **系统优化**: 启用BBR，优化网络参数，配置SWAP
- **fail2ban**: 防止SSH暴力破解和DDoS攻击
- **系统清理**: 自动清理日志、缓存、临时文件和旧内核

### 代理部署模块
- **Xray-core安装**: 自动下载最新版本并配置systemd服务
- **REALITY配置**: 生成密钥对，配置VLESS-HTTP2-REALITY协议
- **客户端配置**: 生成多平台客户端配置文件和分享链接
- **网络质量检测**: 全面的网络性能测试和线路质量评估

### 服务管理模块
- **服务控制**: 启动、停止、重启所有相关服务
- **状态监控**: 实时查看服务运行状态和资源使用情况
- **日志管理**: 查看各服务的详细日志信息
- **健康检查**: 全面的系统健康状况检查和问题诊断

### 配置管理模块
- **配置备份**: 自动备份所有重要配置文件
- **配置恢复**: 从备份中恢复配置文件
- **配置导入导出**: 支持配置文件的导入导出功能
- **版本管理**: 管理多个配置版本，支持回滚操作

### 测试工具模块
- **连接测试**: 测试SSH、Xray、防火墙等服务连接状态
- **性能测试**: CPU、内存、磁盘、网络性能全面测试
- **安全测试**: 系统安全配置检查和漏洞扫描
- **配置验证**: 验证配置文件语法和有效性

### 批量操作模块
- **多选菜单**: 支持多选操作，批量执行配置任务
- **进度显示**: 实时显示批量操作进度
- **智能选择**: 支持全选和单选组合
- **操作确认**: 执行前显示选中操作列表

### 快速工具安装模块
- **开发工具包**: 一键安装Git、Vim、编译工具等
- **监控工具**: 安装htop、iotop、nethogs等监控工具
- **Git环境配置**: 自动配置Git用户信息和常用别名
- **环境准备**: 快速准备开发和运维环境

## 配置说明

### SSH配置
- **端口**: 55520（可自定义）
- **认证方式**: 仅密钥认证
- **安全参数**: X11Forwarding启用，UseDNS禁用
- **连接保活**: ClientAliveInterval 60秒

### 防火墙规则
- **默认策略**: 拒绝所有入站连接
- **开放端口**: SSH(55520)、HTTP(80)、HTTPS(443)
- **DDoS防护**: 连接频率限制和SYN洪水防护
- **IPv6支持**: 自动检测并配置IPv6规则

### 代理配置
- **协议**: VLESS
- **传输**: HTTP/2
- **安全层**: REALITY
- **端口**: 443
- **伪装**: 随机选择目标网站

### 网络质量检测
- **延迟测试**: 测试到多个目标的网络延迟
- **带宽测试**: 使用speedtest-cli测试上下行带宽
- **DNS解析**: 测试DNS解析速度和可用性
- **路由追踪**: 分析网络路径和跳数
- **质量评分**: 综合评估网络质量并给出建议

## 客户端配置

### 移动端（推荐）
1. 下载v2rayNG（Android）或Shadowrocket（iOS）
2. 复制脚本生成的VLESS分享链接
3. 在客户端中导入链接

### 电脑端
1. 下载Xray客户端
2. 使用脚本生成的client_config.json配置文件
3. 启动客户端，代理端口：1080（SOCKS）、1081（HTTP）

### Clash客户端
1. 使用脚本生成的clash_config.yaml配置文件
2. 代理端口：7890，控制端口：9090

## 安全注意事项

### 重要提醒
1. **保存SSH私钥**: 脚本会生成新的SSH密钥，请务必保存
2. **测试连接**: 在断开当前SSH连接前，请先测试新的连接
3. **防火墙规则**: 确保防火墙规则正确，避免锁定自己
4. **定期更新**: 建议定期更新Xray-core和系统

### 备份恢复
- 脚本会自动备份重要配置文件到 `/etc/security-hardening/backup/`
- 如需恢复，可以从备份目录中找到原始配置文件

## 故障排除

### 常见问题

**Q: SSH连接被拒绝**
A: 检查新的SSH端口(55520)是否正确，确认防火墙规则是否生效

**Q: 代理无法连接**
A: 检查Xray服务状态，确认防火墙是否开放443端口

**Q: 系统优化后性能下降**
A: 某些优化需要重启系统后生效，建议重启VPS

### 日志查看
```bash
# 查看脚本日志
tail -f /var/log/security-hardening.log

# 查看Xray服务日志
journalctl -u xray -f

# 查看fail2ban日志
tail -f /var/log/fail2ban.log
```

### 服务管理
```bash
# 查看Xray服务状态
systemctl status xray

# 重启Xray服务
systemctl restart xray

# 查看fail2ban状态
fail2ban-client status
```

## 更新日志

### v2.1.1 (最新)
- **重构SSH安全配置**: 使用sshd_config.d目录，避免配置文件冲突
- **新增SSH配置诊断**: 自动检测云服务商配置，智能修复配置问题
- **支持PermitRootLogin prohibit-password**: 允许root仅通过密钥登录
- **增强配置验证**: 使用sshd -T验证配置有效性
- **新增批量操作模式**: 多选菜单系统，支持批量执行配置任务
- **新增快速工具安装**: 一键安装开发工具、监控工具、Git环境配置
- **参考业界最佳实践**: 基于Linux.do社区和专业文档优化

### v2.1.0
- **新增服务管理模块**: 完整的服务启停、状态监控、日志查看功能
- **新增系统清理功能**: 自动清理日志、缓存、临时文件和旧内核
- **新增配置管理模块**: 配置备份、恢复、导入导出功能
- **新增测试工具模块**: 连接测试、性能测试、安全测试
- **增强系统信息显示**: 更详细的硬件、网络、服务状态信息
- **增强健康检查**: 全面的系统健康状况检查和问题诊断
- **优化用户体验**: 改进菜单结构和操作流程，借鉴优秀开源项目设计
- **完善错误处理**: 增强错误恢复和异常处理机制

### v2.0.0
- 完整重构，集成安全加固和代理部署
- 新增VLESS-HTTP2-REALITY协议支持
- 优化用户界面和交互体验
- 增加一键部署功能
- 完善错误处理和日志记录

## 贡献

欢迎提交Issue和Pull Request来改进这个项目。

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 免责声明

本工具仅供学习和研究使用，请遵守当地法律法规。使用本工具所产生的任何后果由使用者自行承担。

## 致谢

- [XTLS/Xray-core](https://github.com/XTLS/Xray-core) - 高性能代理工具
- [YujuToolBox](https://github.com/yuju520/YujuToolBox) - UI设计参考
- [xrayREALITY](https://github.com/oldfriendme/xrayREALITY) - REALITY协议实现参考
